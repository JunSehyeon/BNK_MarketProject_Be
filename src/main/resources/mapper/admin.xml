<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.AdminMapper">

    <!--    개별로 작성할 부분(덩어리 구분) -->

    <sql id="searchWhere">
        <where>
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'code'">
                        AND A.code LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'coupon_name'">
                        AND A.coupon_name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'name'">
                        AND U.name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="selectAllCoupons" resultType="kr.co.bnk_marketproject_be.dto.CouponsDTO">
        SELECT
        A.code,
        A.discount_type as discount_type,
        A.coupon_name as coupon_name,
        A.discount_value as discount_value,
        TO_CHAR(A.valid_from, 'YYYY-MM-DD HH24:MI:SS') as valid_from,
        TO_CHAR(A.valid_to, 'YYYY-MM-DD HH24:MI:SS') as valid_to,
        U.name,
        A.issuecount,
        A.usercount,
        A.status,
        TO_CHAR(A.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at
        FROM coupons A
        JOIN users U
        ON A.users_id = U.id
        <include refid="searchWhere"/>
        ORDER BY A.id DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotal" resultType="int">
        SELECT COUNT(*) FROM coupons A
        JOIN users U
        ON A.users_id = U.id
        <include refid="searchWhere"/>
    </select>

    <!--    개별로 작성할 부분(덩어리 구분) -->

</mapper>