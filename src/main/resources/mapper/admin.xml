<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnk_marketproject_be.mapper.AdminMapper">

    <!--    개별로 작성할 부분(덩어리 구분) -->

    <sql id="searchWhere">
        <where>
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'code'">
                        AND A.code LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'coupon_name'">
                        AND A.coupon_name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'name'">
                        AND U.name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="selectAllCoupons" resultType="kr.co.bnk_marketproject_be.dto.CouponsDTO">
        SELECT
        A.code,
        A.discount_type as discount_type,
        A.coupon_name as coupon_name,
        A.discount_value as discount_value,
        TO_CHAR(A.valid_from, 'YYYY-MM-DD HH24:MI:SS') as valid_from,
        TO_CHAR(A.valid_to, 'YYYY-MM-DD HH24:MI:SS') as valid_to,
        U.name,
        A.issuecount,
        A.usercount,
        A.status,
        TO_CHAR(A.created_at, 'YYYY-MM-DD HH24:MI:SS') AS created_at
        FROM coupons A
        JOIN users U
        ON A.users_id = U.id
        <include refid="searchWhere"/>
        ORDER BY A.id DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotal" resultType="int">
        SELECT COUNT(*) FROM coupons A
        JOIN users U
        ON A.users_id = U.id
        <include refid="searchWhere"/>
    </select>

    <!--    개별로 작성할 부분(덩어리 구분) -->

    <sql id="searchCouponsNowWhere">
        <where>
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'issue_id'">
                        AND A.issue_id LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'coupons_id'">
                        AND A.coupons_id LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'coupon_name'">
                        AND C.coupon_name LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'user_id'">
                        AND U.user_id LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="selectAllCouponsNow" resultType="kr.co.bnk_marketproject_be.dto.CouponsNowDTO">
        SELECT
        A.*,
        C.code,
        C.discount_type as discount_type,
        C.coupon_name as coupon_name,
        C.discount_value as discount_value,
        C.valid_from as valid_from,
        C.valid_to as valid_to,
        U.name,
        U.user_id as user_id
        FROM coupons_now A
        JOIN coupons C
        on A.coupons_id = C.id
        JOIN users U
        on A.users_id = U.id
        <include refid="searchCouponsNowWhere"/>
        ORDER BY A.id DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <select id="selectCountTotalCouponsNow" resultType="int">
        SELECT COUNT(*) FROM coupons_now A
        JOIN coupons C
        on A.coupons_id = C.id
        JOIN users U
        on A.users_id = U.id
        <include refid="searchCouponsNowWhere"/>
    </select>

    <!--    개별로 작성할 부분(덩어리 구분) -->

    <sql id="searchEmployWhere">
        <where>
            <if test="pageRequestDTO.searchType != null and pageRequestDTO.keyword != ''">
                <choose>
                    <when test="pageRequestDTO.searchType == 'id'">
                        AND A.id LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'department'">
                        AND A.department LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'form'">
                        AND A.form LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                    <when test="pageRequestDTO.searchType == 'title'">
                        AND A.title LIKE '%' || #{pageRequestDTO.keyword} || '%'
                    </when>
                </choose>
            </if>
        </where>
    </sql>

    <select id="selectAllAdminEmploy" resultType="kr.co.bnk_marketproject_be.dto.AdminEmployDTO">
        SELECT
        A.*,
        U.name as user_name
        FROM employ A
        JOIN users U
        on A.user_name = U.name
        <include refid="searchEmployWhere"/>
        ORDER BY A.id DESC
        OFFSET #{pageRequestDTO.offset} ROWS
        FETCH NEXT #{pageRequestDTO.size} ROWS ONLY
    </select>

    <delete id="deleteAdminEmploy">
        DELETE FROM employ where id=#{id}
    </delete>

    <select id="selectCountTotalAdminEmploy" resultType="int">
        SELECT COUNT(*) FROM employ A
        JOIN users U
        on A.user_name = U.name
        <include refid="searchEmployWhere"/>
    </select>
</mapper>