<div th:replace="~{admin/_header.html}"></div>

<main style="display: flex; justify-content: center; border-top:1px solid #e2e2e2;">
  <div>
    <aside class="euro-nav" aria-label="관리자 사이드 메뉴">
      <section class="euro-nav__group">
        <h4 class="euro-nav__title">환경설정</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">기본설정</a></li>
          <li class="euro-nav__item"><a href="#">배너관리</a></li>
          <li class="euro-nav__item"><a href="#">약관관리</a></li>
          <li class="euro-nav__item is-active"><a href="#">카테고리</a></li>
          <li class="euro-nav__item"><a href="#">버전관리</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">상점관리</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">상점목록</a></li>
          <li class="euro-nav__item"><a href="#">매출현황</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">회원관리</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">회원목록</a></li>
          <li class="euro-nav__item"><a href="#">포인트관리</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">상품관리</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">상품목록</a></li>
          <li class="euro-nav__item"><a href="#">상품등록</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">주문관리</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">주문현황</a></li>
          <li class="euro-nav__item"><a href="#">배송현황</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">쿠폰관리</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">쿠폰목록</a></li>
          <li class="euro-nav__item"><a href="#">쿠폰발급현황</a></li>
        </ul>
      </section>

      <section class="euro-nav__group">
        <h4 class="euro-nav__title">고객센터</h4>
        <ul class="euro-nav__list">
          <li class="euro-nav__item"><a href="#">공지사항</a></li>
          <li class="euro-nav__item"><a href="#">자주묻는질문</a></li>
          <li class="euro-nav__item"><a href="#">문의하기</a></li>
          <li class="euro-nav__item"><a href="#">채용하기</a></li>
        </ul>
      </section>
    </aside>
  </div>

  <div style="border-left:1px solid #e2e2e2;"></div>

  <div style="margin-left:40px; width:900px; height:1000px;">
    <section class="category-admin">
      <div class="page-head" style="border-bottom: 3px solid #cfcfcf;">
        <div class="title"><b>카테고리</b></div>
        <div class="breadcrumbs">HOME &gt; 환경설정 &gt; <b>카테고리</b></div>
      </div>

      <div class="div-gray" style="margin-bottom: 10px;">
        쇼핑몰 메인, 상품 페이지 사이드 카테고리 메뉴 입니다
      </div>

      <div class="panel">
        <div class="panel-head"></div>

        <!-- 카테고리 트리 -->
        <div class="tree-wrap" aria-label="카테고리 편집">
          <ul class="level-1" id="level1">
            <!-- 1차: 여성패션 -->
            <li class="node" data-id="c1" draggable="true">
              <div class="row" style="border: 1px solid #cfcfcf; border-bottom: none;">
                <button class="drag-handle">▶</button>
                <span class="name" contenteditable="true">여성</span>
                <button class="btn-red btn-del" data-scope="l1">삭제</button>
              </div>
              <ul class="level-2 droppable" style="border-left: 1px solid #cfcfcf; border-right: 1px solid #cfcfcf;">
                <li class="leaf" data-id="c1-1" draggable="true">
                  <div class="row">
                    <span class="name" contenteditable="true">원피스</span>
                    <button class="btn-red btn-del" data-scope="l2">삭제</button>
                  </div>
                </li>
                <li class="leaf" data-id="c1-2" draggable="true">
                  <div class="row">
                    <span class="name" contenteditable="true">티셔츠</span>
                    <button class="btn-red btn-del" data-scope="l2">삭제</button>
                  </div>
                </li>
                <li class="leaf" data-id="c1-3" draggable="true">
                  <div class="row">
                    <span class="name" contenteditable="true">스커트</span>
                    <button class="btn-red btn-del" data-scope="l2">삭제</button>
                  </div>
                </li>
                <li class="leaf" data-id="c1-4" draggable="true">
                  <div class="row">
                    <span class="name" contenteditable="true">주얼리</span>
                    <button class="btn-red btn-del" data-scope="l2">삭제</button>
                  </div>
                </li>
                <li class="leaf add-l2-row">
                    <div class="row">
                    <button class="btn-add add-l2" type="button">+</button>
                    <span class="name">2차 카테고리 추가</span>                    
                    </div>
                </li>
              </ul>              
            </li>

            <!-- 1차: 나머지 예시 -->
            <li class="node" data-id="c2" draggable="true">
              <div class="row" style="border: 1px solid #cfcfcf;">
                <button class="drag-handle">▶</button>                
                <span class="name" contenteditable="true">남성</span>
                <button class="btn-red btn-del" data-scope="l1">삭제</button>
              </div>
              <ul class="level-2 droppable"></ul>
            </li>

            <li class="node" data-id="c5" draggable="true">
              <div class="row">
                <button class="drag-handle">▶</button>
                <span class="name" contenteditable="true">아동</span>
                <button class="btn-red btn-del" data-scope="l1">삭제</button>
              </div>
              <ul class="level-2 droppable"></ul>
            </li>

            <li class="node" data-id="c5" draggable="true">
              <div class="row">
                <button class="drag-handle">▶</button>
                <span class="name" contenteditable="true">향수</span>
                <button class="btn-red btn-del" data-scope="l1">삭제</button>
              </div>
              <ul class="level-2 droppable"></ul>
            </li>

            <li class="node" data-id="c5" draggable="true">
              <div class="row">
                <button class="drag-handle">▶</button>
                <span class="name" contenteditable="true">인기상품</span>
                <button class="btn-red btn-del" data-scope="l1">삭제</button>
              </div>
              <ul class="level-2 droppable"></ul>
            </li>

            <li class="node add-l1-row">
                <div class="row">
                <button class="btn-add add-l1" type="button">+</button>
                <span class="name">1차 카테고리 추가</span>
                </div>
            </li>     
          </ul>
        </div>

        <span class="save-hint" id="saveHint" aria-live="polite"></span>
      </div>
    </section>
    <div class="actions">
        <button class="btn" id="saveBtn" type="button">수정하기</button>
      </div>
  </div>
</main>

    <script>
        (function(){
        let idSeq = 1000;        

        // add 1차
        document.querySelector('.add-l1').addEventListener('click', ()=>{
            const ul = document.getElementById('level1');
            const nid = 'n' + (++idSeq);
            ul.insertAdjacentHTML('beforeend', nodeTemplate(nid, '1차 카테고리'));
            wireNode(ul.lastElementChild);
        });

        // add 2차
        document.querySelectorAll('.add-l2').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const addRow = btn.closest('li.add-l2-row');
            const ul = addRow.parentElement;
            const cid = 'n' + (++idSeq);

            addRow.insertAdjacentHTML(                  
            'beforebegin', 
            leafTemplate(cid, '새 2차 카테고리')
            );
            wireLeaf(addRow.previousElementSibling);    
        });
        });       

        // 저장 (현재 구조 콘솔 출력 + 알림)
        document.getElementById('saveBtn').addEventListener('click', ()=>{
            const data = serialize();

            fetch('/api/saveCategories', {   // ← 백엔드 엔드포인트 주소 맞게 수정
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                console.log('저장 성공:', result);
                const hint = document.getElementById('saveHint');
                hint.textContent = '저장이 완료되었습니다!';
                setTimeout(()=> hint.textContent='', 2500);
            })
            .catch(err => {
                console.error('저장 실패:', err);
                alert('저장 중 오류가 발생했습니다.');
            });
        });

        // --- Drag & Drop ---
        let dragEl = null;

        function onDragStart(e){
            dragEl = e.currentTarget;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', dragEl.dataset.id || '');
            requestAnimationFrame(()=> dragEl.classList.add('ghost'));
        }
        function onDragEnd(){
            dragEl?.classList.remove('ghost');
            document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
            dragEl = null;
        }

        function onDragOverRow(e){
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }
        function onDragLeaveRow(e){
            e.currentTarget.classList.remove('drag-over');
        }

        function onDropRow(e){
            e.preventDefault();
            const targetLi = e.currentTarget.closest('li'); // ← 현재 drop 대상 li

            if (!dragEl || !targetLi || dragEl === targetLi) return;

            // 노드끼리 이동
            if (dragEl.classList.contains('node') && targetLi.classList.contains('node')) {
                targetLi.parentNode.insertBefore(dragEl, targetLi);
            }

            // 리프끼리 이동 (같은 level-2일 때)
            else if (dragEl.classList.contains('leaf') && targetLi.classList.contains('leaf')) {
                targetLi.parentNode.insertBefore(dragEl, targetLi);
            }

            onDragLeaveRow(e);
        }

        function onDragOverList(e){
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        function onDragLeaveList(e){
            e.currentTarget.classList.remove('drag-over');
        }
        function onDropList(e) {
            e.preventDefault();
            const list = e.currentTarget;

            if (!dragEl) return;

            // 2차 카테고리 이동 허용 (다른 1차 밑으로도 가능)
            if (dragEl.classList.contains('leaf') && list.classList.contains('level-2')) {
                const addRow = list.querySelector('.add-l2-row');
                if (addRow) {
                    list.insertBefore(dragEl, addRow); // 항상 "추가" 버튼 위에 들어감
                } else {
                    list.appendChild(dragEl);
                }
            }

            onDragLeaveList(e);
        }

        // 템플릿 & 바인딩        
        function leafTemplate(id, text){
            return `
            <li class="leaf" data-id="${id}" draggable="true">
                <div class="row">
                <span class="name" contenteditable="true">${text}</span>
                <button class="btn-red btn-del" data-scope="l2">삭제</button>
                </div>
            </li>`;
        }
        function wireNode(li){
            // drag
            li.addEventListener('dragstart', onDragStart);
            li.addEventListener('dragend', onDragEnd);
            li.querySelector('.row').addEventListener('dragover', onDragOverRow);
            li.querySelector('.row').addEventListener('dragleave', onDragLeaveRow);
            li.querySelector('.row').addEventListener('drop', onDropRow);            
            
            // delete
            li.querySelector('.btn-del').addEventListener('click', ()=>{
            const label = li.querySelector('.name').textContent.trim();
            if(confirm(`‘${label}’를 삭제할까요?`)){ li.remove(); } // 1차 카테고리 삭제
            });
            // drop into level-2
            const l2 = li.querySelector('.level-2');
            l2.addEventListener('dragover', onDragOverList);
            l2.addEventListener('dragleave', onDragLeaveList);
            l2.addEventListener('drop', onDropList);
        }
        
        function wireLeaf(li){
            li.addEventListener('dragstart', onDragStart);
            li.addEventListener('dragend', onDragEnd);
            li.querySelector('.row').addEventListener('dragover', onDragOverRow);
            li.querySelector('.row').addEventListener('dragleave', onDragLeaveRow);
            li.querySelector('.row').addEventListener('drop', onDropRow);
            li.querySelector('.btn-del').addEventListener('click', ()=>{
            const label = li.querySelector('.name').textContent.trim();
            if(confirm(`‘${label}’를 삭제할까요?`)){ li.remove(); } // 2차 카테고리 삭제
            });
        }

        // 초기 바인딩
        document.querySelectorAll('.node').forEach(wireNode);
        document.querySelectorAll('.leaf').forEach(wireLeaf);

        // 직렬화
        function serialize(){
            const l1 = [];
            document.querySelectorAll('#level1 > .node').forEach(node=>{
            const item = {
                id: node.dataset.id,
                name: node.querySelector('.name').textContent.trim(),
                children: []
            };
            node.querySelectorAll('.level-2 > .leaf').forEach(leaf=>{
                item.children.push({
                    id: leaf.dataset.id,
                    name: leaf.querySelector('.name').textContent.trim()
                });
            });
            l1.push(item);
            });
            return l1;
        }
        })();
        </script>


    <style>
        .euro-nav__list {
            max-height: 0;                /* 기본은 접힘 */
            overflow: hidden;             /* 안 보이게 */
            transition: max-height 0.15s ease;
        }

            .euro-nav__group.open .euro-nav__list {
            max-height: 500px;            /* 펼쳐졌을 때 (충분히 크게 설정) */
        }
    </style>
    <script>
        // 아코디언: 클릭 시 높이를 실제 내용 높이로 애니메이션
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.style.cursor = 'pointer'; // 클릭 가능 시각화(선택)
    title.addEventListener('click', () => {
      const group = title.parentElement;
      const list  = group.querySelector('.euro-nav__list');

      const isOpen = group.classList.contains('open');

      if (isOpen) {
        // 닫기: 현재 높이를 고정 -> 0으로
        list.style.maxHeight = list.scrollHeight + 'px';
        // 강제 리플로우로 트랜지션 시작점 확정
        list.offsetHeight; 
        list.style.maxHeight = '0px';
        group.classList.remove('open');
      } else {
        // 열기: 0 -> 내용 높이
        group.classList.add('open');
        list.style.maxHeight = list.scrollHeight + 'px';

        // 애니메이션 끝나면 inline max-height 제거(자연스런 레이아웃)
        const onEnd = (e) => {
          if (e.propertyName === 'max-height') {
            list.style.maxHeight = 'none';
            list.removeEventListener('transitionend', onEnd);
          }
        };
        list.addEventListener('transitionend', onEnd);
      }
    });
  });

  const groups = document.querySelectorAll('.euro-nav__group');
  document.querySelectorAll('.euro-nav__title').forEach(title => {
    title.addEventListener('click', () => {
      groups.forEach(g => {
        if (g !== title.parentElement && g.classList.contains('open')) {
          const l = g.querySelector('.euro-nav__list');
          l.style.maxHeight = l.scrollHeight + 'px';
          l.offsetHeight;
          l.style.maxHeight = '0px';
          g.classList.remove('open');
        }
      });
    }, {capture:true});
  });
  
    </script>
<div th:replace="~{admin/_footer.html}"></div>